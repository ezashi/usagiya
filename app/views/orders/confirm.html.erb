<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">ご注文内容確認</h1>

    <%= form_with model: @order, url: orders_path, method: :post do |f| %>
    <!-- Hidden fields to preserve form data -->
    <%= f.hidden_field :customer_name %>
    <%= f.hidden_field :postal_code %>
    <%= f.hidden_field :address %>
    <%= f.hidden_field :phone %>
    <%= f.hidden_field :email %>
    <%= f.hidden_field :same_address %>
    <%= f.hidden_field :delivery_name unless @order.same_address? %>
    <%= f.hidden_field :delivery_postal_code unless @order.same_address? %>
    <%= f.hidden_field :delivery_address unless @order.same_address? %>
    <%= f.hidden_field :delivery_phone unless @order.same_address? %>
    <%= f.hidden_field :payment_method %>
    <%= f.hidden_field :delivery_date %>
    <%= f.hidden_field :delivery_time %>
    <%= f.hidden_field :wrapping_type %>
    <%= f.hidden_field :notes %>

    <%= f.fields_for :order_items do |item_form| %>
    <%= item_form.hidden_field :product_type %>
    <%= item_form.hidden_field :quantity %>
    <% end %>

    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
        <h2 class="text-2xl font-bold mb-4">ご注文者様情報</h2>
        <div class="space-y-2">
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">お名前</p>
                <p class="col-span-3"><%= @order.customer_name %></p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">郵便番号</p>
                <p class="col-span-3"><%= @order.postal_code %></p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">住所</p>
                <p class="col-span-3"><%= @order.address %></p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">電話番号</p>
                <p class="col-span-3"><%= @order.phone %></p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">E-MAIL</p>
                <p class="col-span-3"><%= @order.email %></p>
            </div>
        </div>
    </div>

    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
        <h2 class="text-2xl font-bold mb-4">お送り先</h2>
        <% if @order.same_address? %>
        <p class="text-gray-700">※ご注文者様と同じ</p>
        <% else %>
        <div class="space-y-2">
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">お名前</p>
                <p class="col-span-3"><%= @order.delivery_name %></p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">郵便番号</p>
                <p class="col-span-3"><%= @order.delivery_postal_code %></p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">住所</p>
                <p class="col-span-3"><%= @order.delivery_address %></p>
            </div>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">電話番号</p>
                <p class="col-span-3"><%= @order.delivery_phone %></p>
            </div>
        </div>
        <% end %>
    </div>

    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
        <h2 class="text-2xl font-bold mb-4">ご注文内容</h2>
        <table class="w-full">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 text-left">商品名</th>
                    <th class="px-4 py-2 text-right">数量</th>
                    <th class="px-4 py-2 text-right">単価</th>
                    <th class="px-4 py-2 text-right">小計</th>
                </tr>
            </thead>
            <tbody>
                <% @order.order_items.reject { |item| item.quantity.to_i == 0 }.each do |item| %>
                <tr class="border-b">
                    <td class="px-4 py-2"><%= item.product_name %></td>
                    <td class="px-4 py-2 text-right"><%= item.quantity %>個</td>
                    <td class="px-4 py-2 text-right">¥<%= number_with_delimiter(item.price_per_unit) %></td>
                    <td class="px-4 py-2 text-right">¥<%= number_with_delimiter(item.subtotal) %></td>
                </tr>
                <% end %>
            </tbody>
            <tfoot class="bg-gray-100 font-bold">
                <tr>
                    <td colspan="3" class="px-4 py-3 text-right">合計</td>
                    <td class="px-4 py-3 text-right">¥<%= number_with_delimiter(@order.order_items.sum(&:subtotal)) %></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6">
        <h2 class="text-2xl font-bold mb-4">配送・お支払い情報</h2>
        <div class="space-y-2">
            <% if @order.delivery_date.present? %>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">到着希望日</p>
                <p class="col-span-3"><%= @order.delivery_date.strftime("%Y年%m月%d日") %></p>
            </div>
            <% end %>
            <% if @order.delivery_time.present? %>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">希望到着時間</p>
                <p class="col-span-3"><%= @order.delivery_time %></p>
            </div>
            <% end %>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">お支払い方法</p>
                <p class="col-span-3"><%= Order.payment_method_options.key(@order.payment_method) %></p>
            </div>
            <% if @order.wrapping_type.present? %>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">包装</p>
                <p class="col-span-3"><%= @order.wrapping_type %></p>
            </div>
            <% end %>
            <% if @order.notes.present? %>
            <div class="grid grid-cols-4 gap-4">
                <p class="text-gray-700 font-bold">ご希望欄</p>
                <p class="col-span-3 whitespace-pre-wrap"><%= @order.notes %></p>
            </div>
            <% end %>
        </div>
    </div>

    <div class="flex justify-between items-center">
        <%= button_tag type: :button, onclick: "history.back()", class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg" do %>
        内容を修正する
        <% end %>
        <%= f.submit "この内容で注文する", class: "bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg cursor-pointer" %>
    </div>
    <% end %>
</div>