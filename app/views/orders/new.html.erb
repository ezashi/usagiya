<%= render 'shared/header' %>

<style>
    body {
        margin: 0;
        padding: 0;
        background: linear-gradient(to bottom, #fef3f2, #ffffff);
    }

    .order-page-container {
        padding-top: 140px;
        padding-bottom: 4rem;
        min-height: 100vh;
    }

    .wrapping-sample-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }

    html {
        scroll-behavior: smooth;
    }
</style>

<div class="order-page-container">
    <div class="max-w-7xl mx-auto px-8 sm:px-12 lg:px-16">

        <!-- ページヘッダー -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">冷凍もちパイ注文</h1>
            <p class="text-gray-600">必要事項をご入力ください</p>
        </div>

        <!-- 冷凍もちパイ発送についての説明 -->
        <div class="bg-white rounded-xl shadow-md p-10 mb-8">
            <!-- ヘッダー部分（タイトルとボタン） -->
            <div class="flex justify-between items-start mb-8">
                <h2 class="text-3xl font-bold text-gray-900">「もちパイ」冷凍発送について</h2>
                <a href="#order-form" class="inline-flex items-center px-6 py-3 bg-white border-2 border-gray-800 text-gray-800 font-bold rounded hover:bg-gray-50 transition-colors">
                    注文フォームへ
                </a>
            </div>

            <!-- メインコンテンツ -->
            <div class="grid md:grid-cols-2 gap-12 items-start">
                <!-- 左側: 説明文と発送の流れ -->
                <div class="space-y-6">
                    <!-- 説明文 -->
                    <div class="text-gray-700 text-base">
                        <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">「もちパイの焼きたてを召し上がっていただきたい」そんな思いで作っています。</p>
                        <br>
                        <p>「遠くの方にも召し上がっていただきたい」そんな気持ちも持っています。</p>
                        <br>
                        <p>もちパイを作りたて、焼きたてのまま、おいしくお届けできないだろうか...</p>
                        <br>
                        <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">...いろいろ考え試行錯誤の末、作りたてを急速に冷凍発送してお送りできるようになりました。</p>
                    </div>

                    <!-- 発送の流れ -->
                    <div class="mt-8">
                        <p class="font-bold text-lg text-gray-800 mb-4">「もちパイ」発送の流れ</p>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="text-pink-600 font-bold text-lg mr-3 flex-shrink-0">①</span>
                                <span class="text-gray-700">うさぎや店舗にてパイで包み焼きあげます。</span>
                            </div>
                            <div class="pl-8 text-gray-400 text-2xl">↓</div>
                            <div class="flex items-start">
                                <span class="text-pink-600 font-bold text-lg mr-3 flex-shrink-0">②</span>
                                <span class="text-gray-700">急速冷凍します</span>
                            </div>
                            <div class="pl-8 text-gray-400 text-2xl">↓</div>
                            <div class="flex items-start">
                                <span class="text-pink-600 font-bold text-lg mr-3 flex-shrink-0">③</span>
                                <span class="text-gray-700">梱包して発送します</span>
                            </div>
                            <div class="pl-8 text-gray-400 text-2xl">↓</div>
                            <div class="flex items-start">
                                <span class="text-pink-600 font-bold text-lg mr-3 flex-shrink-0">④</span>
                                <span class="text-gray-700">お客様にお届け</span>
                            </div>
                            <div class="pl-8 text-gray-400 text-2xl">↓</div>
                            <div class="flex items-start">
                                <span class="text-pink-600 font-bold text-lg mr-3 flex-shrink-0">⑤</span>
                                <span class="text-gray-700" style="white-space: nowrap;">お召し上がりの約2時間前に自然解凍　→　⑥そのままお召し上がりください</span>
                            </div>
                            <div class="pl-8 text-gray-400 text-2xl">↓</div>
                            <div class="flex items-start">
                                <span class="text-pink-600 font-bold text-lg mr-3 flex-shrink-0">⑥</span>
                                <span class="text-gray-700" style="white-space: nowrap;">トースターで約2~3分焼いてお召し上がりいただくと一層おいしくなります♪</span>
                            </div>
                        </div>

                        <div class="mt-6 text-gray-600 text-sm">
                            <p>☆消費期限は解凍前...約20日間</p>
                            <p class="ml-14">解凍後...翌日中</p>
                        </div>
                    </div>
                </div>

                <!-- 右側: メイン画像 -->
                <div class="flex items-start justify-end">
                    <% begin %>
                    <%= image_tag 'orders/reitoumotipai.png', 
                          alt: '冷凍もちパイ', 
                          class: 'w-full max-w-sm rounded-lg shadow-md object-contain',
                          style: 'height: auto;' %>
                    <% rescue => e %>
                    <div class="w-full max-w-sm h-64 bg-gray-200 rounded-lg flex items-center justify-center">
                        <p class="text-gray-500">reitoumotipai.png</p>
                    </div>
                    <% end %>
                </div>
            </div>

            <!-- 下部の画像配置 -->
            <div class="flex justify-between items-end mt-8" style="height: 320px;">
                <!-- 左側の画像（小さめ） -->
                <div class="flex-shrink-0" style="width: 40%;">
                    <% begin %>
                    <%= image_tag 'orders/reitou.png', 
                          alt: '冷凍保存', 
                          class: 'w-full rounded-lg shadow-md object-contain',
                          style: 'height: 250px;' %>
                    <% rescue => e %>
                    <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center">
                        <p class="text-gray-500">reitou.png</p>
                    </div>
                    <% end %>
                </div>

                <!-- 右側の画像と説明（大きめ） -->
                <div class="flex-shrink-0 position-relative" style="width: 55%;">
                    <div class="relative">
                        <% begin %>
                        <%= image_tag 'orders/housounashi_motipai.jpg', 
                              alt: 'もちパイ専用箱', 
                              class: 'w-full rounded-lg shadow-md object-contain',
                              style: 'height: 320px;' %>
                        <% rescue => e %>
                        <div class="w-full h-80 bg-gray-200 rounded-lg flex items-center justify-center">
                            <p class="text-gray-500">housounashi_motipai.jpg</p>
                        </div>
                        <% end %>

                        <!-- 専用箱の説明（画像内の下部に配置） -->
                        <div class="absolute bottom-4 left-0 right-0 text-center">
                            <p class="text-base text-gray-800 font-medium bg-white bg-opacity-90 px-4 py-2 inline-block rounded">
                                ※もちパイ専用の箱は、6個入り・8個入り・10個入り・12個入り・15個入り・20個入りがございます。
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 注意事項 -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-8">
                <p class="text-red-800 font-bold text-sm">
                    ⚠️ 2〜3日前までのご注文は受け付けできません。年末年始、連休前は1週間の余裕を持ってご注文ください。お急ぎの方はお電話にてご相談ください。
                </p>
                <p class="text-red-700 text-sm mt-2">TEL: 0778-62-0861</p>
            </div>
        </div>

        <!-- 注文フォーム -->
        <div id="order-form" class="bg-white rounded-xl shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                注文フォーム
            </h2>

            <%= form_with(model: @order, local: true, html: { class: 'space-y-6' }) do |f| %>
            <% if @order.errors.any? %>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <h4 class="text-red-800 font-bold mb-2">入力内容に問題があります:</h4>
                <ul class="list-disc list-inside text-red-700 text-sm">
                    <% @order.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                    <% end %>
                </ul>
            </div>
            <% end %>

            <!-- ご注文者様情報 -->
            <div class="border rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">ご注文者様情報</h3>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            お名前 <span class="text-red-500">*</span>
                        </label>
                        <%= f.text_field :customer_name, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            電話番号 <span class="text-red-500">*</span>
                        </label>
                        <%= f.text_field :phone, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            郵便番号 <span class="text-red-500">*</span>
                        </label>
                        <%= f.text_field :postal_code, placeholder: '例: 916-0071', class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            E-MAIL <span class="text-red-500">*</span>
                        </label>
                        <%= f.email_field :email, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ご住所 <span class="text-red-500">*</span>
                        </label>
                        <%= f.text_field :address, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                    </div>
                </div>
            </div>

            <!-- 送り先 -->
            <div class="border rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">送り先</h3>

                <div class="mb-4">
                    <label class="flex items-center">
                        <%= f.check_box :same_address, { class: 'mr-2', id: 'same-address-check' } %>
                        <span class="text-sm">ご注文者様と同じ住所に送る</span>
                    </label>
                </div>

                <div id="different-address-fields" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                お送り先のお名前 <span class="text-red-500">*</span>
                            </label>
                            <%= f.text_field :delivery_name, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                お送り先の電話番号 <span class="text-red-500">*</span>
                            </label>
                            <%= f.text_field :delivery_phone, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                お送り先の郵便番号 <span class="text-red-500">*</span>
                            </label>
                            <%= f.text_field :delivery_postal_code, placeholder: '例: 916-0071', class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                お送り先のご住所 <span class="text-red-500">*</span>
                            </label>
                            <%= f.text_field :delivery_address, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 注文商品 -->
            <div class="border rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">注文商品</h3>

                <div class="space-y-3">
                    <%= f.fields_for :order_items do |item_form| %>
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-700 flex-1">
                            <%= item_form.object.product_type.gsub('mochipai_', 'もちパイ').gsub('_', '') %>
                        </label>
                        <%= item_form.hidden_field :product_type %>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">数:</span>
                            <%= item_form.number_field :quantity, 
                                    min: 0, 
                                    value: 0,
                                    class: 'w-20 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 text-center' %>
                        </div>
                    </div>
                    <% end %>
                </div>

                <div class="mt-4 pt-4 border-t">
                    <div class="text-right">
                        <span class="font-bold text-lg text-gray-800">合計: ¥<span id="total-price">0</span></span>
                    </div>
                </div>
            </div>

            <!-- 支払い方法 -->
            <div class="border rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">支払い方法 <span class="text-red-500">*</span></h3>

                <div class="space-y-3">
                    <label class="flex items-start">
                        <%= f.radio_button :payment_method, 'credit_card', class: 'mt-1 mr-2' %>
                        <div>
                            <span class="text-sm">クレジットカード払い</span>
                            <p class="text-xs text-gray-600 mt-1">VISA / Master / JCB / American Express / ダイナースクラブ</p>
                        </div>
                    </label>

                    <label class="flex items-start">
                        <%= f.radio_button :payment_method, 'cod', class: 'mt-1 mr-2' %>
                        <div>
                            <span class="text-sm">代引き</span>
                            <p class="text-xs text-gray-600 mt-1">手数料がかかります</p>
                        </div>
                    </label>

                    <label class="flex items-start">
                        <%= f.radio_button :payment_method, 'bank_transfer_fukui', class: 'mt-1 mr-2' %>
                        <div>
                            <span class="text-sm">福井信用金庫 事前振込</span>
                            <p class="text-xs text-gray-600 mt-1">手数料はご負担ください</p>
                        </div>
                    </label>

                    <label class="flex items-start">
                        <%= f.radio_button :payment_method, 'bank_transfer_yucho', class: 'mt-1 mr-2' %>
                        <div>
                            <span class="text-sm">ゆうちょ銀行 事前振込</span>
                            <p class="text-xs text-gray-600 mt-1">手数料はご負担ください</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 配送希望日時 -->
            <div class="border rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">配送希望日時</h3>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            到着希望日
                        </label>
                        <%= f.date_field :delivery_date, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            希望到着時間
                        </label>
                        <%= f.select :delivery_time, 
                            options_for_select([
                                ['時間指定なし', ''],
                                ['午前中', 'morning'],
                                ['14~16時', '14-16'],
                                ['16~18時', '16-18'],
                                ['18~20時', '18-20'],
                                ['19~21時', '19-21']
                            ]), 
                            {}, 
                            { class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' } %>
                    </div>
                </div>
            </div>

            <!-- 包装 -->
            <div class="border rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">包装の有無 <span class="text-red-500">*</span></h3>

                <div class="space-y-3">
                    <label class="flex items-center">
                        <%= f.radio_button :wrapping_type, 'none', class: 'mr-2' %>
                        <span class="text-sm">もちパイ・帯のみ（包装なし）</span>
                    </label>

                    <label class="flex items-center">
                        <%= f.radio_button :wrapping_type, 'usagiya_red', class: 'mr-2' %>
                        <span class="text-sm">「うさぎや」ロゴデザイン・赤</span>
                    </label>

                    <label class="flex items-center">
                        <%= f.radio_button :wrapping_type, 'usagiya_blue', class: 'mr-2' %>
                        <span class="text-sm">「うさぎや」ロゴデザイン・青</span>
                    </label>

                    <label class="flex items-center">
                        <%= f.radio_button :wrapping_type, 'rabbit_pink', class: 'mr-2' %>
                        <span class="text-sm">うさぎ柄・ピンク</span>
                    </label>
                </div>

                <!-- 包装サンプル画像 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <div class="text-center">
                        <% begin %>
                        <%= image_tag 'wrapping/none.jpg', alt: '包装なし', class: 'wrapping-sample-image' %>
                        <% rescue %>
                        <div class="w-full h-32 bg-gray-200 rounded flex items-center justify-center">
                            <span class="text-xs text-gray-500">包装なし</span>
                        </div>
                        <% end %>
                        <p class="text-xs mt-2">包装なし</p>
                    </div>

                    <div class="text-center">
                        <% begin %>
                        <%= image_tag 'wrapping/logo_red.jpg', alt: 'ロゴ・赤', class: 'wrapping-sample-image' %>
                        <% rescue %>
                        <div class="w-full h-32 bg-gray-200 rounded flex items-center justify-center">
                            <span class="text-xs text-gray-500">ロゴ・赤</span>
                        </div>
                        <% end %>
                        <p class="text-xs mt-2">ロゴ・赤</p>
                    </div>

                    <div class="text-center">
                        <% begin %>
                        <%= image_tag 'wrapping/logo_blue.jpg', alt: 'ロゴ・青', class: 'wrapping-sample-image' %>
                        <% rescue %>
                        <div class="w-full h-32 bg-gray-200 rounded flex items-center justify-center">
                            <span class="text-xs text-gray-500">ロゴ・青</span>
                        </div>
                        <% end %>
                        <p class="text-xs mt-2">ロゴ・青</p>
                    </div>

                    <div class="text-center">
                        <% begin %>
                        <%= image_tag 'wrapping/rabbit_pink.jpg', alt: 'うさぎ柄・ピンク', class: 'wrapping-sample-image' %>
                        <% rescue %>
                        <div class="w-full h-32 bg-gray-200 rounded flex items-center justify-center">
                            <span class="text-xs text-gray-500">うさぎ柄</span>
                        </div>
                        <% end %>
                        <p class="text-xs mt-2">うさぎ柄・ピンク</p>
                    </div>
                </div>
            </div>

            <!-- ご希望欄 -->
            <div class="border rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800">ご希望欄</h3>
                <p class="text-sm text-gray-600 mb-3">
                    ※もちパイは組み合わせができますので、種類と個数をご記入ください。（ご記入がない場合はおまかせとなります）<br>
                    ※包装の場合、熨斗の有無（お名前の記入）もあればご記入ください。<br>
                    ※手提げ袋が必要な方はご記入ください。
                </p>
                <%= f.text_area :notes, rows: 4, class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500' %>
            </div>

            <!-- 送信ボタン -->
            <div class="text-center">
                <%= f.submit '確認画面へ', class: 'px-8 py-3 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition-colors cursor-pointer' %>
            </div>

            <% end %>
        </div>
    </div>
</div>

<script>
    // 同じ住所チェックボックスの処理
    document.addEventListener('DOMContentLoaded', function() {
        const sameAddressCheck = document.getElementById('same-address-check');
        const differentAddressFields = document.getElementById('different-address-fields');

        if (sameAddressCheck) {
            sameAddressCheck.addEventListener('change', function() {
                if (this.checked) {
                    differentAddressFields.style.display = 'none';
                } else {
                    differentAddressFields.style.display = 'block';
                }
            });

            // 初期状態の設定
            if (sameAddressCheck.checked) {
                differentAddressFields.style.display = 'none';
            }
        }

        // 価格計算
        const calculateTotal = function() {
            const prices = {
                'mochipai_6': 1200,
                'mochipai_8': 1600,
                'mochipai_10': 2000,
                'mochipai_12': 2400,
                'mochipai_15': 3000,
                'mochipai_20': 4000
            };

            let total = 0;

            Object.keys(prices).forEach(function(productType) {
                const input = document.querySelector(`input[value="${productType}"]`);
                if (input) {
                    const quantityInput = input.parentElement.parentElement.querySelector('input[type="number"]');
                    if (quantityInput) {
                        const quantity = parseInt(quantityInput.value) || 0;
                        total += prices[productType] * quantity;
                    }
                }
            });

            const totalElement = document.getElementById('total-price');
            if (totalElement) {
                totalElement.textContent = total.toLocaleString();
            }
        };

        // 数量変更時に価格を再計算
        document.querySelectorAll('input[type="number"]').forEach(function(input) {
            input.addEventListener('change', calculateTotal);
            input.addEventListener('input', calculateTotal);
        });

        // 初回計算
        calculateTotal();
    });
</script>