<% content_for :title, "冷凍もちパイ注文 - うさぎや" %>
<% content_for :description, "うさぎやの冷凍もちパイのご注文フォーム。お好みの個数を選んでご注文いただけます。" %>

<div class="w-full max-w-4xl mx-auto">
    <!-- ページヘッダー -->
    <div class="mb-12 text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">冷凍もちパイ注文</h1>
        <p class="text-gray-600 text-lg">お好みの個数をお選びください</p>
    </div>

    <!-- パンくずリスト -->
    <nav class="mb-8" aria-label="パンくずリスト">
        <ol class="flex items-center space-x-2 text-sm text-gray-600">
            <li>
                <%= link_to root_path, class: "hover:text-pink-600 transition-colors" do %>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                <% end %>
            </li>
            <li>
                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
            </li>
            <li class="font-medium text-gray-800">冷凍もちパイ注文</li>
        </ol>
    </nav>

    <%= form_with model: @order, url: confirm_orders_path, method: :post, id: "order-form", class: "space-y-8" do |f| %>
    <!-- エラーメッセージ -->
    <% if @order.errors.any? %>
    <div class="bg-red-50 border-2 border-red-200 text-red-800 px-6 py-4 rounded-xl" role="alert">
        <div class="flex items-start">
            <svg class="w-6 h-6 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <h3 class="font-bold mb-2">入力内容にエラーがあります</h3>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <% @order.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                    <% end %>
                </ul>
            </div>
        </div>
    </div>
    <% end %>

    <!-- ステップインジケーター -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between">
            <div class="flex-1 flex items-center">
                <div class="w-10 h-10 bg-pink-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                <div class="ml-3">
                    <p class="font-bold text-gray-800">入力</p>
                    <p class="text-xs text-gray-500">情報を入力</p>
                </div>
            </div>
            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <div class="flex-1 flex items-center justify-center">
                <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold">2</div>
                <div class="ml-3">
                    <p class="font-bold text-gray-500">確認</p>
                    <p class="text-xs text-gray-400">内容を確認</p>
                </div>
            </div>
            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <div class="flex-1 flex items-center justify-end">
                <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold">3</div>
                <div class="ml-3">
                    <p class="font-bold text-gray-500">完了</p>
                    <p class="text-xs text-gray-400">注文完了</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 商品選択 -->
    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <svg class="w-7 h-7 mr-2 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            商品選択
        </h2>

        <p class="text-sm text-gray-600 mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            ※もちパイは種類の組み合わせが可能です。ご希望の場合は、後ほどの「ご希望欄」にご記入ください。
        </p>

        <%= f.fields_for :order_items do |item_form| %>
        <div class="mb-6 last:mb-0 bg-gray-50 rounded-xl p-6 hover:shadow-md transition-shadow">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-800 mb-1">
                        <%= item_form.object.product_name %>
                    </h3>
                    <p class="text-2xl font-bold text-pink-600">
                        ¥<%= number_with_delimiter(item_form.object.price_per_unit) %>
                    </p>
                </div>

                <div class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700 whitespace-nowrap">数量:</label>
                    <div class="flex items-center border-2 border-gray-300 rounded-lg overflow-hidden bg-white">
                        <button type="button" class="quantity-btn px-4 py-2 bg-gray-100 hover:bg-gray-200 font-bold text-gray-700 transition-colors" data-action="decrease" data-target="quantity-<%= item_form.index %>">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                        <%= item_form.number_field :quantity, 
                  value: item_form.object.quantity || 0,
                  min: 0,
                  max: 99,
                  id: "quantity-#{item_form.index}",
                  class: "w-20 text-center py-2 font-bold text-lg border-x-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500",
                  data: { price: item_form.object.price_per_unit } %>
                        <button type="button" class="quantity-btn px-4 py-2 bg-gray-100 hover:bg-gray-200 font-bold text-gray-700 transition-colors" data-action="increase" data-target="quantity-<%= item_form.index %>">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                    <span class="text-sm text-gray-600 whitespace-nowrap">個</span>
                </div>

                <%= item_form.hidden_field :product_type %>
            </div>
        </div>
        <% end %>

        <!-- 合計金額 -->
        <div class="mt-8 pt-6 border-t-2 border-gray-200">
            <div class="flex justify-between items-center text-xl md:text-2xl font-bold">
                <span class="text-gray-800">合計金額:</span>
                <span class="text-pink-600 text-3xl" id="total-amount">¥0</span>
            </div>
            <p class="text-sm text-gray-500 text-right mt-2">※送料は別途かかります</p>
        </div>
    </div>

    <!-- ご注文者様情報 -->
    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <svg class="w-7 h-7 mr-2 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            ご注文者様情報
        </h2>

        <div class="space-y-6">
            <!-- お名前 -->
            <div>
                <%= f.label :customer_name, class: "block text-gray-800 font-bold mb-2" do %>
                お名前
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.text_field :customer_name, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none #{@order.errors[:customer_name].any? ? 'border-red-300 bg-red-50' : ''}", 
            placeholder: "山田 太郎" %>
                <% if @order.errors[:customer_name].any? %>
                <p class="mt-2 text-sm text-red-600"><%= @order.errors[:customer_name].first %></p>
                <% end %>
            </div>

            <!-- 郵便番号 -->
            <div>
                <%= f.label :postal_code, class: "block text-gray-800 font-bold mb-2" do %>
                郵便番号
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.text_field :postal_code, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none #{@order.errors[:postal_code].any? ? 'border-red-300 bg-red-50' : ''}", 
            placeholder: "123-4567" %>
                <p class="mt-1 text-sm text-gray-500">※ハイフンを含めて入力してください（例：123-4567）</p>
                <% if @order.errors[:postal_code].any? %>
                <p class="mt-2 text-sm text-red-600"><%= @order.errors[:postal_code].first %></p>
                <% end %>
            </div>

            <!-- 住所 -->
            <div>
                <%= f.label :address, class: "block text-gray-800 font-bold mb-2" do %>
                住所
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.text_field :address, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none #{@order.errors[:address].any? ? 'border-red-300 bg-red-50' : ''}", 
            placeholder: "福井県福井市中央1-21-23" %>
                <% if @order.errors[:address].any? %>
                <p class="mt-2 text-sm text-red-600"><%= @order.errors[:address].first %></p>
                <% end %>
            </div>

            <!-- 電話番号 -->
            <div>
                <%= f.label :phone, class: "block text-gray-800 font-bold mb-2" do %>
                電話番号
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.tel_field :phone, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none #{@order.errors[:phone].any? ? 'border-red-300 bg-red-50' : ''}", 
            placeholder: "09012345678（ハイフンなし）" %>
                <p class="mt-1 text-sm text-gray-500">※ハイフンなしで入力してください</p>
                <% if @order.errors[:phone].any? %>
                <p class="mt-2 text-sm text-red-600"><%= @order.errors[:phone].first %></p>
                <% end %>
            </div>

            <!-- メールアドレス -->
            <div>
                <%= f.label :email, class: "block text-gray-800 font-bold mb-2" do %>
                メールアドレス
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.email_field :email, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none #{@order.errors[:email].any? ? 'border-red-300 bg-red-50' : ''}", 
            placeholder: "example@example.com" %>
                <p class="mt-1 text-sm text-gray-500">※注文確認メールが届きます</p>
                <% if @order.errors[:email].any? %>
                <p class="mt-2 text-sm text-red-600"><%= @order.errors[:email].first %></p>
                <% end %>
            </div>
        </div>
    </div>

    <!-- お送り先情報 -->
    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <svg class="w-7 h-7 mr-2 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
            </svg>
            お送り先
        </h2>

        <!-- 同じ住所チェックボックス -->
        <div class="mb-6 p-4 bg-pink-50 border-2 border-pink-200 rounded-xl">
            <label class="flex items-start cursor-pointer">
                <%= f.check_box :same_address, class: "mt-1 w-5 h-5 text-pink-600 border-gray-300 rounded focus:ring-pink-500", id: "same-address-checkbox" %>
                <span class="ml-3 font-medium text-gray-700">
                    ご注文者様と同じ住所に送る
                </span>
            </label>
        </div>

        <!-- 別住所入力フィールド -->
        <div id="delivery-address-fields" class="space-y-6">
            <!-- 送り先お名前 -->
            <div>
                <%= f.label :delivery_name, class: "block text-gray-800 font-bold mb-2" do %>
                お名前
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.text_field :delivery_name, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none", 
            placeholder: "佐藤 花子" %>
            </div>

            <!-- 送り先郵便番号 -->
            <div>
                <%= f.label :delivery_postal_code, class: "block text-gray-800 font-bold mb-2" do %>
                郵便番号
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.text_field :delivery_postal_code, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none", 
            placeholder: "123-4567" %>
            </div>

            <!-- 送り先住所 -->
            <div>
                <%= f.label :delivery_address, class: "block text-gray-800 font-bold mb-2" do %>
                住所
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.text_field :delivery_address, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none", 
            placeholder: "東京都渋谷区..." %>
            </div>

            <!-- 送り先電話番号 -->
            <div>
                <%= f.label :delivery_phone, class: "block text-gray-800 font-bold mb-2" do %>
                電話番号
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <%= f.tel_field :delivery_phone, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none", 
            placeholder: "09012345678（ハイフンなし）" %>
            </div>
        </div>
    </div>

    <!-- 配送・お支払い情報 -->
    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <svg class="w-7 h-7 mr-2 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
            </svg>
            配送・お支払い情報
        </h2>

        <div class="space-y-6">
            <!-- 到着希望日 -->
            <div>
                <%= f.label :delivery_date, "到着希望日", class: "block text-gray-800 font-bold mb-2" %>
                <%= f.date_field :delivery_date, 
            min: Date.today + 3.days,
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
                <p class="mt-1 text-sm text-gray-500">※3日後以降の日付を指定してください</p>
            </div>

            <!-- 希望到着時間 -->
            <div>
                <%= f.label :delivery_time, "希望到着時間", class: "block text-gray-800 font-bold mb-2" %>
                <%= f.select :delivery_time, 
            Order.delivery_time_options, 
            { include_blank: "指定なし" },
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
            </div>

            <!-- お支払い方法 -->
            <div>
                <%= f.label :payment_method, class: "block text-gray-800 font-bold mb-2" do %>
                お支払い方法
                <span class="text-red-600 text-sm ml-1">必須</span>
                <% end %>
                <div class="space-y-3">
                    <% Order.payment_method_options.each do |label, value| %>
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-pink-300 cursor-pointer transition-colors <%= @order.payment_method == value ? 'border-pink-500 bg-pink-50' : '' %>">
                        <%= f.radio_button :payment_method, value, class: "mt-1 w-5 h-5 text-pink-600 border-gray-300 focus:ring-pink-500" %>
                        <span class="ml-3 text-gray-700"><%= label %></span>
                    </label>
                    <% end %>
                </div>
                <% if @order.errors[:payment_method].any? %>
                <p class="mt-2 text-sm text-red-600"><%= @order.errors[:payment_method].first %></p>
                <% end %>
            </div>

            <!-- 包装 -->
            <div>
                <%= f.label :wrapping_type, "包装", class: "block text-gray-800 font-bold mb-2" %>
                <%= f.select :wrapping_type, 
            Order.wrapping_options, 
            { include_blank: "選択してください" },
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
            </div>

            <!-- ご希望欄 -->
            <div>
                <%= f.label :notes, "ご希望欄", class: "block text-gray-800 font-bold mb-2" %>
                <%= f.text_area :notes, 
            rows: 6, 
            class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none resize-y", 
            placeholder: "※もちパイは組み合わせができますので、種類と個数をご記入ください。（ご記入がない場合はおまかせとなります）\n※包装の場合、熨斗の有無（お名前の記入）もあればご記入ください。\n※手提げ袋が必要な方はご記入ください。" %>
            </div>
        </div>
    </div>

    <!-- 送信ボタン -->
    <div class="flex flex-col sm:flex-row gap-4">
        <%= link_to "キャンセル", root_path, class: "flex-1 text-center bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 px-6 rounded-xl transition-colors" %>
        <%= f.submit "確認画面へ進む", 
        class: "flex-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl cursor-pointer" %>
    </div>
    <% end %>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 数量ボタンの処理
        document.querySelectorAll('.quantity-btn').forEach(button => {
            button.addEventListener('click', function() {
                const action = this.dataset.action;
                const targetId = this.dataset.target;
                const input = document.getElementById(targetId);
                let value = parseInt(input.value) || 0;

                if (action === 'increase' && value < 99) {
                    value++;
                } else if (action === 'decrease' && value > 0) {
                    value--;
                }

                input.value = value;
                calculateTotal();
            });
        });

        // 数量入力の直接変更
        document.querySelectorAll('input[id^="quantity-"]').forEach(input => {
            input.addEventListener('change', calculateTotal);
        });

        // 合計金額計算
        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('input[id^="quantity-"]').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseInt(input.dataset.price) || 0;
                total += quantity * price;
            });

            document.getElementById('total-amount').textContent = '¥' + total.toLocaleString();
        }

        // 同じ住所チェックボックスの処理
        const sameAddressCheckbox = document.getElementById('same-address-checkbox');
        const deliveryFields = document.getElementById('delivery-address-fields');

        function toggleDeliveryFields() {
            if (sameAddressCheckbox.checked) {
                deliveryFields.style.display = 'none';
                deliveryFields.querySelectorAll('input').forEach(input => {
                    input.removeAttribute('required');
                });
            } else {
                deliveryFields.style.display = 'block';
                deliveryFields.querySelectorAll('input').forEach(input => {
                    if (!input.id.includes('delivery_name') &&
                        !input.id.includes('delivery_postal_code') &&
                        !input.id.includes('delivery_address') &&
                        !input.id.includes('delivery_phone')) {
                        return;
                    }
                    input.setAttribute('required', 'required');
                });
            }
        }

        sameAddressCheckbox.addEventListener('change', toggleDeliveryFields);
        toggleDeliveryFields();

        // 初期表示時の合計金額計算
        calculateTotal();
    });
</script>