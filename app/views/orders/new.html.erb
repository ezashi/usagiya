<% content_for :title, "冷凍もちパイ注文 - うさぎや" %>
<% content_for :description, "うさぎやの冷凍もちパイのご注文フォーム。お好みの個数を選んでご注文いただけます。" %>

<div class="min-h-screen bg-gradient-to-b from-pink-50 to-white py-8 px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-5xl mx-auto">
        <!-- ページヘッダー -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">冷凍もちパイ注文</h1>
            <p class="text-gray-600">必要事項をご入力ください</p>
        </div>

        <!-- ステップインジケーター -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
            <div class="flex items-center justify-center gap-2">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-pink-600 text-white rounded-full flex items-center justify-center font-bold text-sm">1</div>
                    <span class="ml-2 font-bold text-gray-800 hidden sm:inline">入力</span>
                </div>
                <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold text-sm">2</div>
                    <span class="ml-2 text-gray-500 hidden sm:inline">確認</span>
                </div>
                <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold text-sm">3</div>
                    <span class="ml-2 text-gray-500 hidden sm:inline">完了</span>
                </div>
            </div>
        </div>

        <%= form_with model: @order, url: confirm_orders_path, method: :post, id: "order-form", class: "space-y-6" do |f| %>

        <!-- エラーメッセージ -->
        <% if @order.errors.any? %>
        <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <div class="ml-3">
                    <h3 class="text-sm font-bold text-red-800">入力内容にエラーがあります</h3>
                    <ul class="mt-2 text-sm text-red-700 space-y-1">
                        <% @order.errors.full_messages.each do |message| %>
                        <li>• <%= message %></li>
                        <% end %>
                    </ul>
                </div>
            </div>
        </div>
        <% end %>

        <!-- 商品選択セクション -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-gradient-to-r from-pink-600 to-pink-500 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    商品を選ぶ
                </h2>
            </div>

            <div class="p-6">
                <p class="text-sm text-blue-700 bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6 flex items-start">
                    <svg class="w-5 h-5 flex-shrink-0 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <span>もちパイは種類の組み合わせが可能です。ご希望の場合は「ご希望欄」にご記入ください。</span>
                </p>

                <!-- 商品リスト - 2カラムレイアウト -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <%= f.fields_for :order_items do |item_form| %>
                    <% product_info = Order::PRODUCT_PRICES[item_form.object.product_type] %>
                    <% next unless product_info %>

                    <%= item_form.hidden_field :product_type %>

                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-pink-300 transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg"><%= product_info[:name] %></h3>
                                <p class="text-xl font-bold text-pink-600">¥<%= number_with_delimiter(product_info[:price]) %></p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                            <span class="text-gray-700 font-medium">数量</span>
                            <div class="flex items-center gap-2">
                                <button type="button" class="w-9 h-9 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors flex items-center justify-center font-bold text-gray-700" onclick="decrementQuantity(this)">
                                    −
                                </button>
                                <%= item_form.number_field :quantity, 
                                    min: 0,
                                    class: "w-16 text-center px-2 py-2 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none font-bold",
                                    onchange: "updateTotal()" %>
                                <button type="button" class="w-9 h-9 rounded-lg bg-pink-600 hover:bg-pink-700 transition-colors flex items-center justify-center font-bold text-white" onclick="incrementQuantity(this)">
                                    +
                                </button>
                            </div>
                        </div>
                    </div>
                    <% end %>
                </div>

                <!-- 合計金額 -->
                <div class="mt-6 p-4 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg border-2 border-pink-200">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-gray-800">合計金額</span>
                        <span class="text-2xl font-bold text-pink-600" id="total-amount">¥0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- お客様情報セクション -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    ご注文者様の情報
                </h2>
            </div>

            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-5">
                <!-- お名前 -->
                <div class="md:col-span-2">
                    <%= f.label :customer_name, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                    お名前 <span class="text-red-600">*</span>
                    <% end %>
                    <%= f.text_field :customer_name, 
                        class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none",
                        placeholder: "山田 太郎" %>
                </div>

                <!-- 郵便番号 -->
                <div>
                    <%= f.label :postal_code, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                    郵便番号 <span class="text-red-600">*</span>
                    <% end %>
                    <%= f.text_field :postal_code, 
                        class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none",
                        placeholder: "916-0071" %>
                </div>

                <!-- 電話番号 -->
                <div>
                    <%= f.label :phone, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                    電話番号 <span class="text-red-600">*</span>
                    <% end %>
                    <%= f.telephone_field :phone, 
                        class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none",
                        placeholder: "0778620861" %>
                </div>

                <!-- ご住所 -->
                <div class="md:col-span-2">
                    <%= f.label :address, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                    ご住所 <span class="text-red-600">*</span>
                    <% end %>
                    <%= f.text_field :address, 
                        class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none",
                        placeholder: "福井県鯖江市持明寺町5-10-1" %>
                </div>

                <!-- メールアドレス -->
                <div class="md:col-span-2">
                    <%= f.label :email, "メールアドレス", class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                    メールアドレス <span class="text-red-600">*</span>
                    <% end %>
                    <%= f.email_field :email, 
                        class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none",
                        placeholder: "example@example.com" %>
                </div>
            </div>
        </div>

        <!-- お届け先セクション -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-gradient-to-r from-green-600 to-green-500 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    お届け先
                </h2>
            </div>

            <div class="p-6">
                <!-- 送り先選択 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-5">
                    <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all <%= @order.same_address ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-gray-400' %>">
                        <%= f.radio_button :same_address, true, 
                            class: "w-5 h-5 text-green-600", 
                            onclick: "toggleDeliveryAddress(true)" %>
                        <span class="ml-3 font-medium text-gray-700">注文者と同じ</span>
                    </label>
                    <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all <%= !@order.same_address ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-gray-400' %>">
                        <%= f.radio_button :same_address, false, 
                            class: "w-5 h-5 text-green-600",
                            onclick: "toggleDeliveryAddress(false)" %>
                        <span class="ml-3 font-medium text-gray-700">別の住所</span>
                    </label>
                </div>

                <!-- 別住所入力欄 -->
                <div id="delivery-address-fields" class="<%= @order.same_address ? 'hidden' : '' %> grid grid-cols-1 md:grid-cols-2 gap-5 pt-5 border-t-2 border-gray-100">
                    <div class="md:col-span-2">
                        <%= f.label :delivery_name, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                        お名前 <span class="text-red-600">*</span>
                        <% end %>
                        <%= f.text_field :delivery_name, 
                            class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
                    </div>

                    <div>
                        <%= f.label :delivery_postal_code, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                        郵便番号 <span class="text-red-600">*</span>
                        <% end %>
                        <%= f.text_field :delivery_postal_code, 
                            class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
                    </div>

                    <div>
                        <%= f.label :delivery_phone, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                        電話番号 <span class="text-red-600">*</span>
                        <% end %>
                        <%= f.telephone_field :delivery_phone, 
                            class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
                    </div>

                    <div class="md:col-span-2">
                        <%= f.label :delivery_address, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                        ご住所 <span class="text-red-600">*</span>
                        <% end %>
                        <%= f.text_field :delivery_address, 
                            class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配送・支払いセクション -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-purple-500 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                    </svg>
                    配送・お支払い情報
                </h2>
            </div>

            <div class="p-6 space-y-6">
                <!-- 支払い方法 -->
                <div>
                    <%= f.label :payment_method, class: "block text-gray-700 font-bold mb-3 text-sm" do %>
                    支払い方法 <span class="text-red-600">*</span>
                    <% end %>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <% Order::PAYMENT_METHODS.each do |value, label| %>
                        <label class="flex items-start p-3 border-2 rounded-lg cursor-pointer transition-all text-sm <%= @order.payment_method == value ? 'border-purple-500 bg-purple-50' : 'border-gray-300 hover:border-gray-400' %>">
                            <%= f.radio_button :payment_method, value, class: "mt-0.5 w-4 h-4 text-purple-600" %>
                            <span class="ml-2 text-gray-700"><%= label %></span>
                        </label>
                        <% end %>
                    </div>
                </div>

                <!-- 配送日時 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <%= f.label :delivery_date, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                        到着希望日
                        <% end %>
                        <%= f.date_field :delivery_date, 
                            min: Date.today + 3.days,
                            class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
                        <p class="mt-1 text-xs text-gray-500">※3日以降を指定</p>
                    </div>

                    <div>
                        <%= f.label :delivery_time, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                        希望時間帯
                        <% end %>
                        <%= f.select :delivery_time, 
                            Order::DELIVERY_TIMES,
                            { include_blank: "指定なし" },
                            class: "w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none" %>
                    </div>
                </div>

                <!-- 包装 -->
                <div>
                    <%= f.label :wrapping_type, class: "block text-gray-700 font-bold mb-3 text-sm" do %>
                    包装 <span class="text-red-600">*</span>
                    <% end %>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <% Order::WRAPPING_OPTIONS.each do |value, label| %>
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer transition-all text-sm <%= @order.wrapping_type == value ? 'border-purple-500 bg-purple-50' : 'border-gray-300 hover:border-gray-400' %>">
                            <%= f.radio_button :wrapping_type, value, class: "w-4 h-4 text-purple-600" %>
                            <span class="ml-2 text-gray-700"><%= label %></span>
                        </label>
                        <% end %>
                    </div>
                </div>

                <!-- ご希望欄 -->
                <div>
                    <%= f.label :notes, class: "block text-gray-700 font-bold mb-2 text-sm" do %>
                    ご希望欄
                    <% end %>
                    <%= f.text_area :notes, 
                        rows: 4, 
                        class: "w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all outline-none resize-y text-sm", 
                        placeholder: "※もちパイの組み合わせ、熨斗の有無、手提げ袋の必要など、ご希望がありましたらご記入ください。" %>
                </div>
            </div>
        </div>

        <!-- 注意事項 -->
        <div class="bg-amber-50 border-l-4 border-amber-400 rounded-lg p-4">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <div class="text-sm text-amber-800">
                    <p class="font-bold mb-1">ご注意</p>
                    <ul class="space-y-1">
                        <li>• 2〜3日以内に当店よりご連絡いたします</li>
                        <li>• 3日を過ぎても連絡がない場合はお電話ください（0778-62-0861）</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 送信ボタン -->
        <div class="flex gap-3">
            <%= link_to "キャンセル", root_path, class: "flex-1 text-center bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 px-6 rounded-lg transition-colors" %>
            <%= f.submit "確認画面へ進む", 
                class: "flex-1 bg-gradient-to-r from-pink-600 to-pink-500 hover:from-pink-700 hover:to-pink-600 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl",
                data: { disable_with: "処理中..." } %>
        </div>
        <% end %>
    </div>
</div>

<script>
    // 数量の増減
    function incrementQuantity(button) {
        const input = button.previousElementSibling;
        input.value = parseInt(input.value) + 1;
        updateTotal();
    }

    function decrementQuantity(button) {
        const input = button.nextElementSibling;
        if (parseInt(input.value) > 0) {
            input.value = parseInt(input.value) - 1;
            updateTotal();
        }
    }

    // 合計金額の計算
    function updateTotal() {
        const prices = < %= Order::PRODUCT_PRICES.to_json.html_safe % > ;
        let total = 0;

        document.querySelectorAll('[id$="_quantity"]').forEach(input => {
            const hiddenInput = input.closest('.border-2').querySelector('[id$="_product_type"]');
            if (hiddenInput) {
                const type = hiddenInput.value;
                const quantity = parseInt(input.value) || 0;
                if (prices[type]) {
                    total += quantity * prices[type].price;
                }
            }
        });

        document.getElementById('total-amount').textContent = '¥' + total.toLocaleString();
    }

    // 配送先住所の表示切替
    function toggleDeliveryAddress(isSame) {
        const fields = document.getElementById('delivery-address-fields');
        if (isSame) {
            fields.classList.add('hidden');
        } else {
            fields.classList.remove('hidden');
        }
    }

    // ページ読み込み時に合計を計算
    document.addEventListener('DOMContentLoaded', function() {
        updateTotal();
    });
</script>