<% content_for :title, "営業カレンダー - うさぎや" %>

<style>
    /* 営業カレンダー専用スタイル */
    .calendar-page-wrapper {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Arial, sans-serif;
        background: #FAF4EF;
        min-height: 100vh;
    }

    /* カレンダーページヘッダー */
    .calendar-page-header {
        background: #fcedf5;
        padding: 180px 20px 40px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .calendar-page-header h1 {
        font-size: 2.5rem;
        color: #000;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .calendar-page-header p {
        color: #333;
        font-size: 1rem;
    }

    /* カレンダーコンテンツコンテナ */
    .calendar-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        overflow-x: hidden;
    }

    /* カレンダーナビゲーション */
    .calendar-page-nav {
        background: #F9F9F9;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .calendar-page-nav h2 {
        font-size: 40px;
        font-weight: bold;
        color: #333;
    }

    .calendar-nav-buttons {
        display: flex;
        gap: 10px;
    }

    .calendar-nav-button {
        padding: 10px 20px;
        background: #ffc0cb;
        color: #333;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
    }

    .calendar-nav-button:hover {
        background: #ff69b4;
        transform: translateY(-2px);
    }

    /* 凡例 */
    .calendar-legend {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .calendar-legend h3 {
        font-size: 1.1rem;
        color: #333;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .legend-label {
        font-size: 0.9rem;
        color: #333;
    }

    /* カレンダーラッパー */
    .calendar-page-wrapper-inner {
        background: #fff;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        overflow-x: auto;
    }

    .calendar-page-table {
        width: 100%;
        border-collapse: collapse;
    }

    .calendar thead {
        background: linear-gradient(135deg, #ffc0cb 0%, #ffb6c1 100%);
    }

    .calendar th {
        padding: 15px;
        color: #fff;
        font-weight: bold;
        text-align: center;
    }

    .calendar th.sunday {
        color: #ff6b6b;
    }

    .calendar th.saturday {
        color: #4dabf7;
    }

    .calendar-page-table td {
        padding: 10px;
        border: 1px solid #e9ecef;
        vertical-align: top;
        height: 100px;
        background: #fff;
    }

    .calendar-page-table td.empty {
        background: #f8f9fa;
    }

    .calendar-page-table td.sunday {
        background: #ffe0e0;
    }

    .calendar-page-table td.saturday {
        background: #fff;
    }

    .calendar-page-table td.holiday {
        background: #ffebee;
    }

    .calendar-cell-content {
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }

    .calendar-day-number {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }

    .sunday .day-number {
        color: #ff6b6b;
    }

    .calendar-event-label {
        margin: 3px 0;
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
        display: block;
        max-width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        line-height: 1.3;
        border-left: 3px solid transparent;
    }

    /* 定休日 - 赤色 */
    .calendar-event-regular-holiday {
        background: #ef4444;
        color: #fff;
        border-left-color: #dc2626;
    }

    /* 休業日 - 薄紅色 */
    .calendar-event-holiday {
        background: #fca5a5;
        color: #333;
        border-left-color: #f87171;
    }

    /* 不定休 - ピンク */
    .calendar-event-irregular-holiday {
        background: #f472b6;
        color: #fff;
        border-left-color: #ec4899;
    }

    /* 販売開始日 - 黄色 */
    .calendar-event-sales-start {
        background: #f59e0b;
        color: #333;
        border-left-color: #d97706;
    }

    /* 販売終了日 - 青色 */
    .calendar-event-sales-end {
        background: #3b82f6;
        color: #fff;
        border-left-color: #2563eb;
    }

    /* その他 - グレー（カスタムカラーがない場合） */
    .calendar-event-other {
        background: #94a3b8;
        color: #fff;
        border-left-color: #64748b;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 1.8rem;
        }

        .calendar-nav {
            flex-direction: column;
            gap: 15px;
        }

        .calendar-nav h2 {
            font-size: 1.5rem;
        }

        .calendar-page-nav h2 {
            font-size: 28px;
        }

        .calendar td {
            padding: 5px;
            height: 80px;
            font-size: 0.85rem;
        }

        .event-badge {
            font-size: 0.65rem;
            padding: 2px 5px;
        }

        .event-title {
            display: none;
        }

        .legend-items {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>

<body>
    <div class="calendar-page-wrapper">
        <!-- ページヘッダー -->
        <div class="calendar-page-header">
            <h1>営業カレンダー</h1>
            <p>定休日や営業時間をご確認いただけます</p>
        </div>

        <!-- メインコンテンツ -->
        <div class="calendar-container">
            <!-- カレンダーナビゲーション -->
            <div class="calendar-page-nav">
                <div class="calendar-nav-buttons">
                    <%= link_to calendar_events_path(year: @prev_year, month: @prev_month), class: "calendar-nav-button" do %>
                    ← 前月
                    <% end %>
                </div>

                <h2><%= @year %>年<%= @month %>月</h2>

                <div class="calendar-nav-buttons">
                    <%= link_to calendar_events_path(year: @next_year, month: @next_month), class: "calendar-nav-button" do %>
                    次月 →
                    <% end %>
                </div>
            </div>

            <!-- 凡例 -->
            <div class="calendar-legend">
                <h3>凡例</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #ef4444;"></span>
                        <span class="legend-label">定休日</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #fca5a5;"></span>
                        <span class="legend-label">休業日</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #f59e0b;"></span>
                        <span class="legend-label">販売開始日</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #3b82f6;"></span>
                        <span class="legend-label">販売終了日</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #f472b6;"></span>
                        <span class="legend-label">不定休</span>
                    </div>
                </div>
            </div>

            <!-- カレンダー -->
            <div class="calendar-page-wrapper-inner">
                <table class="calendar-page-table">
                    <colgroup>
                        <col style="width: 14.285714%;">
                        <col style="width: 14.285714%;">
                        <col style="width: 14.285714%;">
                        <col style="width: 14.285714%;">
                        <col style="width: 14.285714%;">
                        <col style="width: 14.285714%;">
                        <col style="width: 14.285714%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th class="sunday">日</th>
                            <th>月</th>
                            <th>火</th>
                            <th>水</th>
                            <th>木</th>
                            <th>金</th>
                            <th class="saturday">土</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% @calendar.each_slice(7) do |week| %>
                        <tr>
                            <% week.each_with_index do |day, index| %>
                            <% if day[:date].nil? %>
                            <td class="empty"></td>
                            <% else %>
                            <%
                                is_sunday = day[:date].wday == 0
                                is_saturday = day[:date].wday == 6
                                has_holiday = day[:events].any? { |e| e.respond_to?(:regular_holiday?) && e.regular_holiday? } ||
                                              day[:events].any? { |e| e.respond_to?(:holiday?) && e.holiday? } ||
                                              day[:events].any? { |e| e.respond_to?(:irregular_holiday?) && e.irregular_holiday? }

                                cell_class = ""
                                cell_class += "sunday " if is_sunday
                                cell_class += "saturday " if is_saturday
                                cell_class += "holiday" if has_holiday
                                cell_class = cell_class.strip
                            %>
                            <td class="<%= cell_class %>">
                                <div class="calendar-cell-content">
                                    <div class="calendar-day-number"><%= day[:date].day %></div>
                                    <% day[:events].each do |event| %>
                                    <%
                                        # イベントタイトルの決定
                                        # 定休日、休業日、不定休はタイトル固定
                                        # 販売開始日、販売終了日、その他はタイトルを表示
                                        event_title = if event.respond_to?(:display_title)
                                            event.display_title
                                        else
                                            case event.event_type
                                            when 'regular_holiday'
                                                '定休日'
                                            when 'holiday'
                                                '休業日'
                                            when 'irregular_holiday'
                                                '不定休'
                                            else
                                                event.title.presence || '予定'
                                            end
                                        end

                                        # カスタムスタイルの設定（その他の場合）
                                        custom_style = ""
                                        if event.other? && event.color.present?
                                            # 背景色を設定
                                            custom_style += "background: #{event.color};"

                                            # 背景色に応じてテキスト色を自動調整
                                            color_hex = event.color.gsub('#', '')
                                            if color_hex.length == 6
                                                r = color_hex[0..1].to_i(16)
                                                g = color_hex[2..3].to_i(16)
                                                b = color_hex[4..5].to_i(16)
                                                brightness = (r * 299 + g * 587 + b * 114) / 1000
                                                custom_style += brightness > 155 ? " color: #333;" : " color: #fff;"
                                            end
                                        end
                                    %>
                                    <div class="calendar-event-label calendar-event-<%= event.event_type.tr('_', '-') %>" style="<%= custom_style %>" title="<%= event_title %>">
                                        <%= event_title %>
                                    </div>
                                    <% end %>
                                </div>
                            </td>
                            <% end %>
                            <% end %>
                        </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <%= render 'shared/shop_info' %>

    <script>
        // ハンバーガーメニューの動作(既存のヘッダーに依存)
        document.addEventListener('DOMContentLoaded', function() {
            const hamburger = document.querySelector('.hamburger');
            const overlay = document.querySelector('.overlay');
            const sideMenu = document.querySelector('.side-menu');
            const closeBtn = document.querySelector('.side-menu-close');

            if (hamburger && overlay && sideMenu && closeBtn) {
                hamburger.addEventListener('click', function() {
                    overlay.classList.add('active');
                    sideMenu.classList.add('active');
                });

                overlay.addEventListener('click', function() {
                    overlay.classList.remove('active');
                    sideMenu.classList.remove('active');
                });

                closeBtn.addEventListener('click', function() {
                    overlay.classList.remove('active');
                    sideMenu.classList.remove('active');
                });
            }
        });
    </script>
</body>

</html>
